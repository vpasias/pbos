Create customised Rocky Linux 8 Cloud Image

This is a guide to create Rocky Linux 8 cloud image.

Download Rocky Linux 8.5 minimal iso.:

# cd /mnt/extra/virt/images && curl -sLO http://download.rockylinux.org/pub/rocky/8/isos/x86_64/Rocky-8.5-x86_64-minimal.iso && ls -lah && \
cd /mnt/extra/kvm-install-vm/ && git clone https://github.com/vpasias/pbos.git && cd /mnt/extra/kvm-install-vm/pbos/rocky

### Create root and rocky sha512 hash password using the following command:
### root password
### python -c 'import crypt,getpass; print(crypt.crypt(getpass.getpass(), crypt.mksalt(crypt.METHOD_SHA512)))'
### python3 -c 'import crypt,getpass;pw=getpass.getpass();print(crypt.crypt(pw) if (pw==getpass.getpass("Confirm: ")) else exit())'
###<sha512_root_password>
### rocky user password
### python3 -c 'import crypt,getpass;pw=getpass.getpass();print(crypt.crypt(pw) if (pw==getpass.getpass("Confirm: ")) else exit())'
###<sha512_user_password>
###Edit ks.cfg to put root and user password.:
###rootpw --iscrypted <sha512_root_password>
###user --name=rocky --iscrypted --password <sha512_user_password>

Run rocky_build.sh.:

# chmod +x rocky_build.sh && ./rocky_build.sh

After installation is done, start the VM, log in as a root, update and upgrade packages, upgrade to latest stable long term support Linux Kernel and reboot.:
### virsh start rocky-linux-8
### virsh console rocky-linux-8

localhost login: root

# dnf -y update && dnf upgrade -y && rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org && \
dnf install https://www.elrepo.org/elrepo-release-8.el8.elrepo.noarch.rpm -y && dnf --enablerepo=elrepo-kernel install kernel-lt -y && \
sleep 10 && systemctl reboot

Log in again as root and install what you want.:

# virsh console rocky-linux-8

localhost login: root

# cat /etc/os-release && uname -a
# dnf -y install cloud-utils-growpart curl epel-release python3 bind-utils && dnf -y install openssh-server cloud-init sshpass && \
dnf install -y git vim net-tools wget curl bash-completion iperf3 mtr traceroute netcat socat python3-simplejson xfsprogs jq virtualenv redhat-lsb-core less sudo man-db bind-utils telnet && \
git clone https://github.com/vpasias/pbos.git

Configure cloud-init and set rocky as default login user and enable sshd and cloud-init services..:

# mv /etc/cloud/cloud.cfg /root/cloud.cfg.old && cp /root/pbos/rocky/cloud.cfg /etc/cloud/cloud.cfg && systemctl enable cloud-init sshd

### vi /etc/cloud/cloud.cfg
###...
###ssh_pwauth: 1
###...
###system_info:
###  default_user:
###    name: rocky
###    lock_passwd: false
###    gecos: Cloud User
###    groups: [adm, systemd-journal]
###    sudo: ["ALL=(ALL) ALL"]
###    shell: /bin/bash

Run cleanup.sh inside the VM and exit the console.:

# cp /root/pbos/rocky/cleanup.sh . && chmod +x cleanup.sh && ./cleanup.sh && rm -f cleanup.sh && cd ~ && rm -rf /root/pbos && \
cat /dev/null > ~/.bash_history && history -c && shutdown -h now

### vi cleanup.sh  # copy text from cleanup.sh
### chmod +x cleanup.sh && ./cleanup.sh

Press CTRL+] to close VM console.

Run virt-sysprep for the VM domain.:

# virt-sysprep -d rocky-linux-8
[   0.0] Examining the guest ...
[   5.4] Performing "abrt-data" ...
[   5.4] Performing "backup-files" ...
[   6.1] Performing "bash-history" ...
[   6.2] Performing "blkid-tab" ...
[   6.2] Performing "crash-data" ...
[   6.2] Performing "cron-spool" ...
[   6.3] Performing "dhcp-client-state" ...
[   6.3] Performing "dhcp-server-state" ...
[   6.3] Performing "dovecot-data" ...
[   6.3] Performing "logfiles" ...
[   6.5] Performing "machine-id" ...
[   6.5] Performing "mail-spool" ...
[   6.5] Performing "net-hostname" ...
[   6.6] Performing "net-hwaddr" ...
[   6.8] Performing "pacct-log" ...
[   6.8] Performing "package-manager-cache" ...
[   6.8] Performing "pam-data" ...
[   6.9] Performing "passwd-backups" ...
[   6.9] Performing "puppet-data-log" ...
[   6.9] Performing "rh-subscription-manager" ...
[   6.9] Performing "rhn-systemid" ...
[   7.0] Performing "rpm-db" ...
[   7.0] Performing "samba-db-log" ...
[   7.0] Performing "script" ...
[   7.0] Performing "smolt-uuid" ...
[   7.0] Performing "ssh-hostkeys" ...
[   7.1] Performing "ssh-userdir" ...
[   7.1] Performing "sssd-db-log" ...
[   7.1] Performing "tmp-files" ...
[   7.1] Performing "udev-persistent-net" ...
[   7.2] Performing "utmp" ...
[   7.2] Performing "yum-uuid" ...
[   7.2] Performing "customize" ...
[   7.2] Setting a random seed
[   7.3] Setting the machine ID in /etc/machine-id
[   7.3] Performing "lvm-uuids" ...

Trim the image.:

# cd /mnt/extra/virt/images && mv rocky-8.5-x86_64-genericcloud.qcow2 rocky-8.5-x86_64-genericcloud.qcow2.new && \
qemu-img convert -O qcow2 rocky-8.5-x86_64-genericcloud.qcow2.new CentOS-8-GenericCloud-8.1.1911-20200113.3.x86_64.qcow2

It shrank down from 5GiB to about 2.0GiB.

Undefine the VM.:
# virsh undefine rocky-linux-8
